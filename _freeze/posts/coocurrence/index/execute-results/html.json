{
  "hash": "83a794e7a4fe45ef4765ddb303dc9e35",
  "result": {
    "markdown": "---\ntitle: \"Understanding co-occurrence\"\nsubtitle: \"A randomisation approach\"\ndate: \"2023-02-09\"\ncategories: [\"statistics\", \"code\"] # environmental-change, tagging-and-telemetry, allee-effects, invasive-species, statistics, code\nimage: \"site-species-matrix.png\"\nimage-alt: \"A site by species matrix representing co-occurrences\"\nfilters:\n   - lightbox\nlightbox: auto\n---\n\n\n> Here, I simulate a species co-occurrence problem using only [`base` R](https://www.r-project.org/) and R package [`data.table`](https://cran.r-project.org/package=data.table).\n\n# Simulation\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# libraries\nlibrary(data.table)\n```\n:::\n\n\nObserved co-occurrence can be compared to the expected co-occurrence where the latter is the product of the two species' probability of occurrence multiplied by the number of sampling sites: $E(N_{1,2}) = P(1) \\times P(2) \\times N$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# number of sampling sites (N)\nN <- 100\n\n# probability of encountering species 1\nP1 <- 0.3\n\n# probability of encountering species 1\nP2 <- 0.1\n\n# expected number of sites where they co-occur\nN_12 <- P1 * P2 * N\n\n# print result\nprint(N_12)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 3\n```\n:::\n:::\n\n\nIt can be easier to understand this using a simulation:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# repeat simulation n times\nn <- 10000\n\n# sites & simulation number\ns <- data.table(\"site\" = rep(1:N, n),\n                \"simulation\" = rep(1:n, each = N))\n\n# add species 1 occurrences\ns[, `species 1` := sample(c(0, 1), size = N * n, replace = TRUE, prob = c(1 - P1, P1))]\n\n# add species 2 occurrences\ns[, `species 2` := sample(c(0, 1), size = N * n, replace = TRUE, prob = c(1 - P2, P2))]\n\n# add coocurrence\ns[, `expct cooccur` := as.numeric((`species 1` + `species 2`) == 2)]\nprint(s)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         site simulation species 1 species 2 expct cooccur\n      1:    1          1         1         0             0\n      2:    2          1         0         0             0\n      3:    3          1         0         0             0\n      4:    4          1         1         0             0\n      5:    5          1         0         0             0\n     ---                                                  \n 999996:   96      10000         0         0             0\n 999997:   97      10000         0         0             0\n 999998:   98      10000         0         0             0\n 999999:   99      10000         1         0             0\n1000000:  100      10000         0         1             0\n```\n:::\n\n```{.r .cell-code}\n# number of times the cooccur on average, i.e., expectation\nexpct <- s[, .(c = sum(`expct cooccur`)), \n           by = simulation][, .(Expectation = mean(c))]\n\n# print result\nprint(expct)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   Expectation\n1:       3.024\n```\n:::\n:::\n\n\nLet us assume that we observe these species co-occurring at 10 sites. How likely is it that this is more often than expected by chance?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# observed coocurrences\no <- do.call(\"rbind\",\n             list(matrix(rep(c(1, 1), l), \n                         ncol = 2, byrow = TRUE),\n                  matrix(rep(c(1, 0), (N * P1) - l), \n                         ncol = 2, byrow = TRUE),\n                  matrix(rep(c(0, 1), (N * P2) - l), \n                         ncol = 2, byrow = TRUE),\n                  matrix(rep(c(0, 0), N - (l + ((N * P1) - l) + ((N * P2) - l))), \n                         ncol = 2, byrow = TRUE)))\n\n# add to simulations\ns[, `obsrv cooccur` := rep(as.numeric(rowSums(o) == 2), n)]\n\n# how often is expct <= obsrv?\np <- s[, sum(`obsrv cooccur`) <= sum(`expct cooccur`), \n       by = simulation][, .(n = sum(V1), p = mean(V1))]\n\n# print result\nprint(p)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   n     p\n1: 4 4e-04\n```\n:::\n:::\n\n\nWe can show this on a histogram of the number of co-occurrences in the simulations with the actual number of co-occurrences shown in red.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot histogram\nhist(s[, .(c = sum(`expct cooccur`)), \n       by = simulation]$c,\n     main = \"Histogram of simulated number of co-occurrences\",\n     xlab = \"Number of co-occurrences\")\nabline(v = l, col = \"red\", lwd = 3)\nmtext(paste0(\"p = \", p$p), \n      side = 3, line = 0, at = 10, col = \"red\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n# Reading\n\n-   This can be done more efficiently using a [combinatorial](https://en.wikipedia.org/wiki/Combinatorics) approach: see <https://thatdarndata.com/understanding-species-co-occurrence/>\n\n-   R package [`cooccur`](https://cran.r-project.org/package=cooccur) uses a probabilistic approximation to the combinatorial approach and is still faster\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}